<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static/styles.css">
    <title>Script AI</title>
</head>

<body>
    <div class="header">
        <h1>üìû Script AI</h1>
        <p>Clientes con riesgo de abandono</p>
    </div>

    <div id="loading" class="loading">Cargando clientes...</div>

    <div class="container" id="container"></div>

    <script>
        const API = 'http://localhost:8000';
        const clientes = [
            {
                nombre: "Mar√≠a Garc√≠a L√≥pez",
                probabilidad_churn: 0.9887073040008545,
                datos: {
                    gender: "Female",
                    SeniorCitizen: 0,
                    Partner: "No",
                    Dependents: "No",
                    tenure: 1,
                    PhoneService: "Yes",
                    MultipleLines: "Yes",
                    InternetService: "Fiber optic",
                    OnlineSecurity: "No",
                    OnlineBackup: "No",
                    DeviceProtection: "No",
                    TechSupport: "No",
                    StreamingTV: "Yes",
                    StreamingMovies: "Yes",
                    Contract: "Month-to-month",
                    PaperlessBilling: "Yes",
                    PaymentMethod: "Electronic check",
                    MonthlyCharges: 93.85,
                    TotalCharges: 93.85
                }
            },
            {
                nombre: "Carlos Rodr√≠guez P√©rez",
                probabilidad_churn: 0.9846387505531311,
                datos: {
                    gender: "Male",
                    SeniorCitizen: 0,
                    Partner: "No",
                    Dependents: "No",
                    tenure: 1,
                    PhoneService: "Yes",
                    MultipleLines: "Yes",
                    InternetService: "Fiber optic",
                    OnlineSecurity: "No",
                    OnlineBackup: "No",
                    DeviceProtection: "No",
                    TechSupport: "No",
                    StreamingTV: "No",
                    StreamingMovies: "Yes",
                    Contract: "Month-to-month",
                    PaperlessBilling: "Yes",
                    PaymentMethod: "Electronic check",
                    MonthlyCharges: 86.6,
                    TotalCharges: 86.6
                }
            },
            {
                nombre: "Pedro L√≥pez Mart√≠nez",
                datos: {
                    gender: "Male",
                    SeniorCitizen: 0,
                    Partner: "No",
                    Dependents: "No",
                    tenure: 1,
                    PhoneService: "Yes",
                    MultipleLines: "No",
                    InternetService: "Fiber optic",
                    OnlineSecurity: "No",
                    OnlineBackup: "No",
                    DeviceProtection: "Yes",
                    TechSupport: "No",
                    StreamingTV: "Yes",
                    StreamingMovies: "No",
                    Contract: "Month-to-month",
                    PaperlessBilling: "Yes",
                    PaymentMethod: "Electronic check",
                    MonthlyCharges: 84.85,
                    TotalCharges: 84.85
                }
            },
            {
                nombre: "Juan Fern√°ndez Sanz",
                datos: {
                    gender: "Male",
                    SeniorCitizen: 0,
                    Partner: "No",
                    Dependents: "No",
                    tenure: 1,
                    PhoneService: "Yes",
                    MultipleLines: "Yes",
                    InternetService: "Fiber optic",
                    OnlineSecurity: "No",
                    OnlineBackup: "No",
                    DeviceProtection: "No",
                    TechSupport: "No",
                    StreamingTV: "No",
                    StreamingMovies: "No",
                    Contract: "Month-to-month",
                    PaperlessBilling: "Yes",
                    PaymentMethod: "Electronic check",
                    MonthlyCharges: 74.9,
                    TotalCharges: 74.9
                }
            },
            {
                nombre: "Ana Ruiz Gim√©nez",
                datos: {
                    gender: "Female",
                    SeniorCitizen: 0,
                    Partner: "No",
                    Dependents: "No",
                    tenure: 1,
                    PhoneService: "Yes",
                    MultipleLines: "No",
                    InternetService: "Fiber optic",
                    OnlineSecurity: "No",
                    OnlineBackup: "No",
                    DeviceProtection: "No",
                    TechSupport: "No",
                    StreamingTV: "No",
                    StreamingMovies: "No",
                    Contract: "Month-to-month",
                    PaperlessBilling: "Yes",
                    PaymentMethod: "Electronic check",
                    MonthlyCharges: 69.5,
                    TotalCharges: 69.5
                }
            },
            {
                nombre: "Laura Mart√≠nez S√°nchez",
                datos: {
                    gender: "Female",
                    SeniorCitizen: 0,
                    Partner: "No",
                    Dependents: "Yes",
                    tenure: 1,
                    PhoneService: "Yes",
                    MultipleLines: "No",
                    InternetService: "Fiber optic",
                    OnlineSecurity: "No",
                    OnlineBackup: "No",
                    DeviceProtection: "No",
                    TechSupport: "No",
                    StreamingTV: "Yes",
                    StreamingMovies: "Yes",
                    Contract: "Month-to-month",
                    PaperlessBilling: "Yes",
                    PaymentMethod: "Electronic check",
                    MonthlyCharges: 89.35,
                    TotalCharges: 89.35
                }
            },
            {
                nombre: "Isabel Fern√°ndez G√≥mez",
                datos: {
                    gender: "Female",
                    SeniorCitizen: 1,
                    Partner: "No",
                    Dependents: "No",
                    tenure: 2,
                    PhoneService: "Yes",
                    MultipleLines: "Yes",
                    InternetService: "Fiber optic",
                    OnlineSecurity: "No",
                    OnlineBackup: "No",
                    DeviceProtection: "Yes",
                    TechSupport: "No",
                    StreamingTV: "No",
                    StreamingMovies: "Yes",
                    Contract: "Month-to-month",
                    PaperlessBilling: "Yes",
                    PaymentMethod: "Electronic check",
                    MonthlyCharges: 88.55,
                    TotalCharges: 179.25
                }
            },
            {
                nombre: "Roberto D√≠az Torres",
                datos: {
                    gender: "Female",
                    SeniorCitizen: 1,
                    Partner: "No",
                    Dependents: "No",
                    tenure: 2,
                    PhoneService: "Yes",
                    MultipleLines: "Yes",
                    InternetService: "Fiber optic",
                    OnlineSecurity: "No",
                    OnlineBackup: "No",
                    DeviceProtection: "No",
                    TechSupport: "No",
                    StreamingTV: "No",
                    StreamingMovies: "Yes",
                    Contract: "Month-to-month",
                    PaperlessBilling: "Yes",
                    PaymentMethod: "Electronic check",
                    MonthlyCharges: 84.05,
                    TotalCharges: 186.05
                }
            }
        ];

        function cargar() {
            const container = document.getElementById("container");
            document.getElementById("loading").style.display = "none";

            clientes.forEach((cliente, index) => {
                fetch(`${API}/predict`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(cliente.datos)
                })
                .then(res => res.json())
                .then(pred => {
                    const prob = pred.probabilidad_churn;
                    let nivel = "";

                    if (prob > 0.65) nivel = "alto";
                    else if (prob > 0.45) nivel = "medio";
                    else nivel = "bajo"

                    const row = document.createElement("div");
                    row.className = "cliente-row";

                    row.innerHTML = `
                        <div class="card ${nivel}">
                            <h3>${cliente.nombre}</h3>
                            <span class="badge ${nivel}">${nivel.toUpperCase()}</span>
                            <div class="prob">${(prob * 100).toFixed(1)}%</div>
                            <p><strong>Contrato:</strong> ${cliente.datos.Contract}</p>
                            <p><strong>Meses:</strong> ${cliente.datos.tenure}</p>
                            <p><strong>Cargo:</strong> $${cliente.datos.MonthlyCharges}</p>
                            <div class="buttons">
                                <button class="btn-llamar">üìû Llamar</button>
                                <button class="btn-guion">Generar Mail</button>
                            </div>
                        </div>
                        <div class="guion" id="guion-${index}">Generando Mail...</div>
                    `;

                    container.appendChild(row);

                    const botonGuion = row.querySelector(".btn-guion");
                    botonGuion.addEventListener("click", async () => {
                        const divGuion = document.getElementById(`guion-${index}`);
                        divGuion.style.display = "block";
                        divGuion.innerHTML = "‚úèÔ∏è Generando mail personalizado...";

                        try {
                            const res = await fetch(`${API}/generate_script`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    nombre: cliente.nombre,
                                    probabilidad_churn: prob,
                                    tenure: cliente.datos.tenure,
                                    monthly_charges: cliente.datos.MonthlyCharges,
                                    contract: cliente.datos.Contract
                                })
                            });

                            if (!res.ok) throw new Error(`Error ${res.status}`);

                            const data = await res.json();
                            divGuion.innerHTML = `
                                <strong>üí¨ Gui√≥n para ${cliente.nombre}:</strong><br><br>
                                ${data.guion.replace(/\n/g, "<br>")}
                            `;
                        } catch (error) {
                            console.error("Error generando el gui√≥n:", error);
                            divGuion.innerHTML = "‚ùå Error generando el gui√≥n. Intenta de nuevo.";
                        }
                    });
                })
                .catch(err => console.error("Error con " + cliente.nombre, err));
            });
        }

        cargar();
    </script>
</body>
</html>